<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book a Service - MGoMom</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #001E3C; color: #f7f7f7; margin: 0; padding: 2rem; }
        .form-container { max-width: 600px; margin: 0 auto; background-color: #022b59; padding: 2rem; border-radius: 8px; }
        h1 { color: #FFCB05; }
        label { display: block; margin-top: 1rem; font-weight: 700; }
        input, select, textarea { width: 100%; padding: 0.75rem; margin-top: 0.5rem; border-radius: 4px; border: 1px solid #ccc; font-size: 1rem; }
        .cta-button { display: inline-block; width: 100%; text-align: center; background-color: #FFCB05; color: #001E3C; font-weight: 700; padding: 0.75rem 1rem; border-radius: 5px; border: none; font-size: 1.1rem; cursor: pointer; margin-top: 2rem; transition: background-color 0.3s; }
        .cta-button:hover { background-color: #f0c000; }
        .service-section { display: none; border-top: 2px solid #FFCB05; margin-top: 1.5rem; padding-top: 1rem; }
        #auth-message { text-align: center; font-size: 1.2rem; }
        #auth-message a { color: #FFCB05; font-weight: bold; }
    </style>
</head>
<body>

    <div class="form-container">
        <h1>Book a Service</h1>
        <div id="auth-message">
            <p>Loading...</p>
        </div>

        <form id="booking-form" style="display: none;">
            <label for="parent-name">Your Full Name *</label>
            <input type="text" id="parent-name" required>

            <label for="student-name">Student's Full Name *</label>
            <input type="text" id="student-name" required>
            
            <label for="student-address">Student's Campus Address (Dorm & Room #) *</label>
            <input type="text" id="student-address" required>

            <label for="service-select">Select a Service *</label>
            <select id="service-select" required>
                <option value="">-- Please choose an option --</option>
                <option value="Care Kit">Customized Care Kit</option>
                <option value="Local Delivery">Pickup for Local Delivery</option>
                <option value="Urgent Care">Accompaniment to Urgent Care</option>
                </select>

            <div id="section-care-kit" class="service-section">
                <label for="care-kit-type">Which Care Kit?</label>
                <select id="care-kit-type">
                    <option>Exam Stress Relief</option>
                    <option>Birthday/Holiday Box</option>
                    <option>Sick Day Essentials</option>
                    <option>Customize My Own</option>
                </select>
                <label for="delivery-date">Preferred Delivery Date</label>
                <input type="date" id="delivery-date">
            </div>
            
            <div id="section-urgent-care" class="service-section">
                <p style="font-weight: bold;">If this is an emergency, please dial 911. For immediate help, call us directly.</p>
                <label for="appointment-date">Date of Appointment</label>
                <input type="date" id="appointment-date">
                <label for="pickup-location">Pickup Location (On Campus)</label>
                <input type="text" id="pickup-location" placeholder="e.g., Mosher-Jordan Lobby">
            </div>

            <label for="service-notes">Additional Notes or Special Instructions</label>
            <textarea id="service-notes" placeholder="e.g., Please include a handwritten note that says 'Good luck!'"></textarea>

            <button type="submit" class="cta-button">Submit Request</button>
        </form>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB56B8O99N8bzQQAMgPdYKwGU6wIsPgeQk",
            authDomain: "mgomom-33d39.firebaseapp.com",
            projectId: "mgomom-33d39",
            storageBucket: "mgomom-33d39.firebasestorage.app",
            messagingSenderId: "431667209818",
            appId: "1:431667209818:web:44544d38e97720a4425a63",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const bookingForm = document.getElementById('booking-form');
        const authMessage = document.getElementById('auth-message');
        const serviceSelect = document.getElementById('service-select');

        // Show/hide form based on login status
        onAuthStateChanged(auth, (user) => {
            if (user) {
                bookingForm.style.display = 'block';
                authMessage.style.display = 'none';
                // Pre-fill parent's name if available
                document.getElementById('parent-name').value = user.displayName || '';
            } else {
                bookingForm.style.display = 'none';
                authMessage.innerHTML = '<p>You must be signed in to book a service. <a href="/index.html">Click here to sign in.</a></p>';
            }
        });

        // Show/hide specific sections based on service selection
        serviceSelect.addEventListener('change', () => {
            document.querySelectorAll('.service-section').forEach(section => {
                section.style.display = 'none';
            });
            const selectedValue = serviceSelect.value.toLowerCase().replace(/ /g, '-');
            const sectionToShow = document.getElementById(`section-${selectedValue}`);
            if (sectionToShow) {
                sectionToShow.style.display = 'block';
            }
        });

        // Handle the form submission
        bookingForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) return alert('You must be signed in!');

            const orderData = {
                // User Info
                userId: user.uid,
                userEmail: user.email,
                userName: document.getElementById('parent-name').value,
                // Order Details
                studentName: document.getElementById('student-name').value,
                studentAddress: document.getElementById('student-address').value,
                service: serviceSelect.value,
                notes: document.getElementById('service-notes').value,
                // Status and Timestamp
                status: "new",
                createdAt: serverTimestamp()
            };

            try {
                await addDoc(collection(db, "orders"), orderData);
                alert("Success! Your request has been submitted. We will be in touch shortly.");
                window.location.href = '/index.html'; // Redirect to home page after success
            } catch (error) {
                console.error("Error submitting request:", error);
                alert("There was an error. Please try again.");
            }
        });
    </script>
</body>
</html>