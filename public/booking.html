<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book a Service - MGoMom</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #001E3C; color: #f7f7f7; margin: 0; padding: 2rem; }
        .form-container { max-width: 600px; margin: 0 auto; background-color: #022b59; padding: 2rem; border-radius: 8px; }
        h1 { color: #FFCB05; }
        label, legend { display: block; margin-top: 1rem; font-weight: 700; }
        input:not([type="radio"]):not([type="checkbox"]), select, textarea { width: 100%; padding: 0.75rem; margin-top: 0.5rem; border-radius: 4px; border: 1px solid #ccc; font-size: 1rem; box-sizing: border-box; background-color: #00172d; color: #f7f7f7; }
        .cta-button { display: inline-block; width: 100%; text-align: center; background-color: #FFCB05; color: #001E3C; font-weight: 700; padding: 0.75rem 1rem; border-radius: 5px; border: none; font-size: 1.1rem; cursor: pointer; margin-top: 2rem; transition: background-color 0.3s; }
        #auth-message a { color: #FFCB05; font-weight: bold; }
        
        /* Specific Section Styles */
        .service-specific-fields { border: 1px solid #0a3d7f; border-radius: 5px; padding: 1rem; margin-top: 1rem; }
        .service-specific-fields legend { font-size: 1.25rem; color: #FFCB05; }
        .kit-radio-group label { display: inline-flex; align-items: center; gap: 0.4rem; font-weight: normal; cursor: pointer; margin-right: 1.5rem;}
        #kit-ingredients { background-color: #00172d; padding: 1rem; margin-top: 1rem; border-radius: 5px; min-height: 50px; }
        .disclaimer { font-size: 0.8rem; color: #cccccc; font-style: italic; margin-top: 0.5rem; }
        /* --- Style to make the date picker icon white --- */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="form-container">
        <h1>Book a Service</h1>
        <div id="auth-message"><p>Loading...</p></div>

        <form id="booking-form" style="display: none;">
            <label for="parent-name">Your Full Name *</label>
            <input type="text" id="parent-name" name="parentName" required>
            <label for="parent-phone">Your Phone Number *</label>
            <input type="tel" id="parent-phone" name="parentPhone" placeholder="(123) 456-7890" required>
            <label for="parent-email">Your Email *</label>
            <input type="email" id="parent-email" name="parentEmail" placeholder="your.email@example.com" required>
            <hr style="border-color: #FFCB05; margin: 2rem 0;">
            <label for="student-name">Student's Full Name *</label>
            <input type="text" id="student-name" name="studentName" required>

            <label for="student-phone">Student's Phone Number *</label>
            <input type="tel" id="student-phone" name="studentPhone" placeholder="(123) 456-7890" required>

            <label for="service-select">Select a Service *</label>
            <select id="service-select" name="service" required>
                <option value="">-- Please choose an option --</option>
                <option value="Customized Care Kit">Customized Care Kit</option>
                <option value="Urgent Care">Urgent Care Assistance</option>
                <option value="Move-In/Move-Out Help">Move-In/Move-Out Help</option>
                <option value="Airport Pickup">Airport Pickup</option>
                <option value="Out-of-State Student Package">Out-of-State Student Package</option>
                <option value="Special Request">Special Request</option>
            </select>
            
            <div id="service-fields-container"></div>

            <label for="service-notes">Additional Notes or Special Instructions</label>
            <textarea id="service-notes" name="notes" placeholder="e.g., Allergies, specific instructions, etc."></textarea>
            <button type="submit" class="cta-button">Submit Request</button>
        </form>
    </div>

    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyB56B8O99N8bzQQAMgPdYKwGU6wIsPgeQk",
        authDomain: "mgomom-33d39.firebaseapp.com",
        projectId: "mgomom-33d39",
        storageBucket: "mgomom-33d39.appspot.com",
        messagingSenderId: "431667209818",
        appId: "1:431667209818:web:44544d3g"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const bookingForm = document.getElementById('booking-form');
    const authMessage = document.getElementById('auth-message');
    const parentNameInput = document.getElementById('parent-name');
    const parentEmailInput = document.getElementById('parent-email');
    const parentPhoneInput = document.getElementById('parent-phone');

    onAuthStateChanged(auth, (user) => {
        bookingForm.style.display = 'block'; // Always show the form

        if (user) {
            // User is logged in
            authMessage.innerHTML = `<p>Welcome, ${user.displayName || user.email}! You are booking as a registered user. <a href="#" id="logout-link">Log out?</a></p>`;
            document.getElementById('logout-link').addEventListener('click', () => auth.signOut());

            // Pre-fill fields from user's profile
            parentNameInput.value = user.displayName || '';
            parentEmailInput.value = user.email || '';
        } else {
            // User is a guest
            authMessage.innerHTML = `<p>You are booking as a guest. To track your orders online, please <a href="/login.html?redirect=/booking.html">log in or create an account</a>.</p>`;
        }
    });

    // --- All your dynamic form logic (serviceTemplates, listeners, etc.) remains the same ---
    const serviceSelect = document.getElementById('service-select');
    const fieldsContainer = document.getElementById('service-fields-container');

    const serviceTemplates = {
        "Customized Care Kit": `
        <div class="service-specific-fields">
            <legend>Choose a Care Kit</legend>
            <label for="delivery-date">Desired Delivery Date *</label>
            <input type="date" id="delivery-date" name="deliveryDate" required>
            <div class="kit-radio-group">
                <label><input type="radio" name="kitType" value="Exam Stress Relief Kit"> Exam Stress Relief</label>
                <label><input type="radio" name="kitType" value="Birthday or Holiday Box"> Birthday/Holiday</label>
                <label><input type="radio" name="kitType" value="Sick Day Essentials"> Sick Day</label>
            </div>
            <div id="kit-ingredients"><p>Select a kit to see what's inside.</p></div>
        </div>`,
        "Urgent Care": `
        <div class="service-specific-fields">
            <legend>Urgent Care Details</legend>
            <label for="assistance-datetime">Date & Time Needed *</label>
            <input type="datetime-local" id="assistance-datetime" name="assistanceDateTime" required>
            <label for="facility-name">Preferred Urgent Care Facility</label>
            <input type="text" id="facility-name" name="facilityName" placeholder="e.g., Michigan Medicine Urgent Care">
            <label for="reason">Reason for Visit (Injury/Sickness) *</label>
            <textarea id="reason" name="reason" required></textarea>
            <label for="emergency-contact">Emergency Contact (Name & Phone) *</label>
            <input type="text" id="emergency-contact" name="emergencyContact" required placeholder="In case I need to reach someone else.">
        </div>`,
        "Move-In/Move-Out Help": `
        <div class="service-specific-fields">
            <legend>Move-In / Move-Out Details</legend>
            <div>
                <label><input type="radio" name="moveType" value="Move-In" checked> Move-In</label>
                <label><input type="radio" name="moveType" value="Move-Out"> Move-Out</label>
            </div>
            <label for="Service-date">Move Date *</label>
            <input type="date" id="Service-date" name="ServiceDate" required>
            <label for="move-address">Student's Address *</label>
            <input type="text" id="move-address" name="moveAddress" required>
            <div id="storage-section">
                <label><input type="checkbox" id="ship-items-checkbox"> Ship items to my house beforehand?</label>
                <div id="storage-list-container" style="display:none;">
                    <label>Items to Store:</label>
                    <textarea name="storageItems" placeholder="List each item on a new line..."></textarea>
                    <p class="disclaimer">Shipping is a flat rate of $200 per apartment (maximum 6 months holding time).
                    Large items will incur an extra charge at the discretion of MGoMom, which will be brought up before purchase.</p>
                </div>
            </div>
        </div>`,
        "Airport Pickup": `
        <div class="service-specific-fields">
            <legend>Airport Pickup Details</legend>
            <label for="pickup-datetime">Pickup Date & Time *</label>
            <input type="datetime-local" id="pickup-datetime" name="pickupDateTime" required>
            <label for="flight-number">Flight Number *</label>
            <input type="text" id="flight-number" name="flightNumber" placeholder="e.g., DL1234" required>
            <label for="dropoff-location">Drop-off Location *</label>
            <input type="text" id="dropoff-location" name="dropoffLocation" required>
            <label for="luggage-amount">Amount of Luggage</label>
            <input type="text" id="luggage-amount" name="luggageAmount" placeholder="e.g., 2 large bags, 1 carry-on">
        </div>`,
        "Out-of-State Student Package": `
        <div class="service-specific-fields">
            <legend>Out-of-State Student Package</legend>
            <label for="pickup-datetime">Pickup Date & Time *</label>
            <input type="datetime-local" id="pickup-datetime" name="pickupDateTime" required>
            <label for="flight-number">Flight Number *</label>
            <input type="text" id="flight-number" name="flightNumber" placeholder="e.g., DL1234" required>
            <label for="dropoff-location">Drop-off Location *</label>
            <input type="text" id="dropoff-location" name="dropoffLocation" required>
            <label for="luggage-amount">Amount of Luggage</label>
            <input type="text" id="luggage-amount" name="luggageAmount" placeholder="e.g., 2 large bags, 1 carry-on">
            <label for="Service-date">Move Date *</label>
            <input type="date" id="Service-date" name="ServiceDate" required>
            <label for="move-address">Student's Address *</label>
            <input type="text" id="move-address" name="moveAddress" required>
        </div>`,
        "Special Request": `
        <div class="service-specific-fields">
            <legend>Special Request Details</legend>
            <p>Please describe your request in as much detail as possible. We will review it and provide a quote.</p>
            <label for="request-details">Your Request *</label>
            <textarea id="request-details" name="requestDetails" required></textarea>
        </div>`
    };

    serviceSelect.addEventListener('change', () => {
        const selected = serviceSelect.value;
        fieldsContainer.innerHTML = serviceTemplates[selected] || '';

        if (selected === 'Customized Care Kit') {
            document.querySelectorAll('input[name="kitType"]').forEach(radio => {
                radio.addEventListener('change', onKitTypeChange);
            });
        } else if (selected === 'Move-In/Move-Out Help') {
            const checkbox = document.getElementById('ship-items-checkbox');
            checkbox.addEventListener('change', () => {
                document.getElementById('storage-list-container').style.display = checkbox.checked ? 'block' : 'none';
            });
        }
    });

    function onKitTypeChange(event) {
        const kitData = {
            "Exam Stress Relief Kit": { title: "Exam Stress Relief Kit", ingredients: "Includes: Healthy snacks, energy drinks, a stress ball, and encouraging handwritten notes." },
            "Birthday or Holiday Box": { title: "Birthday or Holiday Box", ingredients: "Includes: Seasonal goodies, festive treats, fun decorations, and a celebratory card." },
            "Sick Day Essentials": { title: "Sick Day Essentials", ingredients: "Includes: Hot soup, herbal tea, honey, tissues, cough drops, and other comfort items." }
        };
        const selectedKit = kitData[event.target.value];
        if (selectedKit) {
            document.getElementById('kit-ingredients').innerHTML = `<h4>${selectedKit.title}</h4><p>${selectedKit.ingredients}</p>`;
        }
    }

    bookingForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const user = auth.currentUser;

        // --- START: Add this new validation block here ---
        const parentPhone = document.getElementById('parent-phone').value.replace(/\D/g, '');
        const studentPhone = document.getElementById('student-phone').value.replace(/\D/g, '');

        if (parentPhone.length !== 10) {
            alert("Please enter a valid 10-digit phone number for 'Your Phone Number'.");
            return; // Stop the form submission
        }

        if (studentPhone.length !== 10) {
            alert("Please enter a valid 10-digit phone number for 'Student's Phone Number'.");
            return; // Stop the form submission
        }
        // --- END: New validation block ---

        const formData = new FormData(bookingForm);
        const data = Object.fromEntries(formData.entries());

        // Add user info depending on whether they are a guest or logged in
        if (user) {
            data.userId = user.uid;
            data.userEmail = user.email; // Use the verified email
            data.userName = user ? (user.displayName || data.parentName) : data.parentName; // Use profile name if available, otherwise use the name from the form
        } else {
            data.userId = 'guest';
            data.userEmail = data.parentEmail; // Get email from the new form field
            data.userName = data.parentName;
        }
        
        // Remove temporary form fields from the final data object
        delete data.parentName;
        delete data.parentEmail;
        
        data.createdAt = serverTimestamp();

        try {
            await addDoc(collection(db, "orders"), data);
            alert("Success! Your request has been submitted. We will contact you shortly with updates.");
            window.location.href = user ? '/dashboard.html' : '/index.html'; // Go to dashboard if logged in, otherwise homepage
        } catch (error) {
            console.error("Error submitting request:", error);
            alert("There was an error. Please try again.");
        }
    });
</script>
</body>
</html>